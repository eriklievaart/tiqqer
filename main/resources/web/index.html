<html>
<head>
 <link rel="stylesheet" media="screen" href="/tiqqer/style.css"/>
</head>
<body>

<form onsubmit="config(); return false;">
	level
	<select id="lvl" name="level" onchange="config();">
		<option value="FINEST">  FINEST  </option>
		<option value="FINE">    FINE    </option>
		<option value="INFO">    INFO    </option>
		<option value="WARNING"> WARNING </option>
		<option value="SEVERE">  SEVERE  </option>
	</select>
	class
	<input id="clz" type="text" oninput="config();">
	message
	<input id="msg" type="text" oninput="config();">
	lines
	<input id="lns" type="text" size="4" value="30" oninput="config();">
	buffer
	<input id="buf" type="text" size="4" value="10000" oninput="config();">
	<input type="submit" onclick="cls();" value="clear log">
</form>

<table>
	<thead>
		<tr>
			<th>level</th>
			<th>class</th>
			<th>message</th>
		</tr>
	</thead>
	<tbody id="tbody">
	</tbody>
</table>

<div id="message"></div>




<script>

// todo:
/*

fix: debug flag to suppress logging output
refactor: merge tiqqer-web and tiqqer-websocket

show stacktraces
fix: escape HTML

*/


url = window.location.href + '-socket';
url = url.replace(/^http/, 'ws');

ws = new WebSocket(url);
console.log('creating websocket');

function config() {
	if (typeof ws !== 'undefined') {
		var lvl = document.getElementById('lvl').value;
		var clz = document.getElementById('clz').value;
		var msg = document.getElementById('msg').value;
		var lns = document.getElementById('lns').value;
		var buf = document.getElementById('buf').value;
		ws.send('config level=' + lvl + ' class=' + clz + ' message=' + msg + ' lines=' + lns + ' buffer=' + buf);
	}
}

function cls() {
	ws.send('clear');
	return false;
}

function fetch() {
	if (typeof ws === 'undefined') {
		document.getElementById('message').innerHTML = 'not connected!';
	} else {
		ws.send('fetch');
	}
}

function shorten(name) {
	short=name.replace(/.*[.]/g, '')
	return '<span title="' + name + '">' + short + '</span>'
}

ws.onopen = function() {
	document.getElementById('message').innerHTML = 'connected!';
	config();
};

ws.onmessage = function(raw){
	var trs = '';
	var lines = raw.data.split();

	if(lines != "") {

		for (var line of raw.data.split("\n")) {
			cells = line.split(',', 3);
			trs += '<tr class="' + cells[0].toLowerCase() + '">';
			trs += '<td>' + cells[0] + '</td>'
			trs += '<td>' + shorten(cells[1]) + '</td>'
			trs += '<td>' + cells[2] + '</td>'
			trs += '</tr>';
		}
	}
	document.getElementById('tbody').innerHTML = trs;
	document.getElementById('message').innerHTML = '';
};

ws.onclose = function() {
	document.getElementById('message').innerHTML += 'closed!';
};

setInterval(fetch, 100); 

</script>

</body>
</html>
